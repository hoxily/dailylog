2021年07月13日，星期二，杭州

个人的力量太过单薄，所以我上互联网上搜索了一下 source code of diablo，结果真找到了相关的内容。一个是 GalaXyHaXz 重写的devilution，对应于 diablo 1。一个是OpenDiablo2项目组重写的OpenDiablo2.它们都属于那种只提供程序代码，但是不提供游戏数据文件的那种。*.mpq 这些数据文件的大小要比dll和exe要大得多。想要数据文件，需要用户先购买游戏。

不过 OpenDiablo2 的实现语言是Go。这就蛋疼了。

最近github访问老是出问题。仓库clone不下来。会出现下面这两种报错：
1. ssh: Could not resolve hostname github.com: Name or service not known
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists.

2. fatal: the remote end hung up unexpectedly MiB | 2.76 MiB/s
Connection to github.com closed by remote host.
fatal: early EOF
fatal: index-pack failed

网突然好了，于是git clone成功了。

----

go mod tidy 命令下载依赖包总是失败。参照 https://www.cnblogs.com/smuzoey/p/13915368.html ，添加一个go env即可：

go env -w GOPROXY=https://goproxy.io,direct

虽然还是有点慢，但是比之前直接连接失败要好得多。

----

发现了另一个仓库，OpenD2 ( https://github.com/eezstreet/OpenD2 )。

----

遇到一个ZIP包格式的obj模型上传失败问题。https://www.tapd.cn/37349361/bugtrace/bugs/view/1137349361001013842

出错原因是123MB的zip解包之后，obj文件有673MB大小。这时向JSZIP请求这个字符串，会因为Array.join报错：Uncaught (in promise) RangeError: Invalid string length

优化的思路是，既然不能有这么长的String，那么当作Uint8Array来读取行不行呢？

在本地测试代码上，又试一下单独上传解包后的 obj文件，使用FileReader的readAsText方法读取这个File时，并不会报错，但是读取的result结果是空字符串。

----

在网上找到的一篇文章是说，File 继承自 Blob，所以可以使用Blob的slice方法，进行切分。这样就可以实现文件分片读取。这也是一个优化点。参见：https://blog.csdn.net/lizixiang1993/article/details/45243547

----

遇到vscode提示 Blob 存在 arrayBuffer 函数，但是用typescript编译，却又报 Property 'arrayBuffer' does not exist on type 'Blob' 的错误。参见：https://github.com/microsoft/TypeScript/issues/34652 。看起来用FileReader的兼容性会更好一些。

----

问题已搞定。
